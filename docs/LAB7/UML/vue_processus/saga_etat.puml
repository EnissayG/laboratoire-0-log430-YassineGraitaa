@startuml
title Machine d'Ã©tat â€“ Commande orchestrÃ©e (Saga)

[*] --> INITIEE : DÃ©but saga

INITIEE --> STOCK_RESERVE : âœ… Panier valide + stock disponible
STOCK_RESERVE --> PAIEMENT_EFFECTUE : âœ… Paiement acceptÃ©
PAIEMENT_EFFECTUE --> COMMANDE_ENREGISTREE : âœ… Vente enregistrÃ©e
COMMANDE_ENREGISTREE --> CONFIRMEE : âœ… SuccÃ¨s global

' ğŸ’¥ Transitions dâ€™Ã©chec avec rollback
INITIEE --> ECHEC_STOCK : âŒ Stock insuffisant
STOCK_RESERVE --> ECHEC_PAIEMENT : âŒ Paiement refusÃ©\nâ†’ rollback stock
PAIEMENT_EFFECTUE --> ECHEC_ENREGISTREMENT : âŒ Erreur enregistrement vente\nâ†’ rollback stock + remboursement

' ğŸ”š Ã‰tats terminaux
ECHEC_STOCK --> ANNULEE
ECHEC_PAIEMENT --> ANNULEE
ECHEC_ENREGISTREMENT --> ANNULEE

CONFIRMEE --> [*]
ANNULEE --> [*]

@enduml
